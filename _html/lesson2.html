<!DOCTYPE html>
<html>
<head>
<title>Don't write libraries</title>
<meta name="generator" content="md2html">
</head>
<body>
<p>[<a href="index.html">index</a>]</p>
<h1>Don't write libraries</h1>
<p>There are a ton of Jsonnet libraries out there, ranging from big generated libraries
to manually curated for a very specific purpose. Let's have a look at how to find and
vendor them.</p>
<h2>Objectives</h2>
<ul>
<li>Find existing libraries</li>
<li>Vendor and update libraries with jsonnet-bundler</li>
<li><code>import</code> and use a vendored library with <code>JSONNET_PATH</code></li>
<li>Develop on a vendored library</li>
<li>Generate new libraries from specifications</li>
</ul>
<h2>Lesson</h2>
<p>The ecosystem for Jsonnet libraries has organically grown and is quite distributed, there
is no central entity in control. Even though this gives the authors a great deal of
autonomy, it makes it harder to find libraries. The majority of libraries can be found in
Git repositories and are wholeheartedly open source.</p>
<ul>
<li>Github Topic <a href="https://github.com/topics/jsonnet-lib"><code>jsonnet-lib</code></a> lists the libraries
that are tagged with <code>jsonnet-lib</code>. Cultivating this tag is encouraged.</li>
<li>In the observability space, there is a sub-ecosystem of &quot;mixins&quot;. The <a href="https://monitoring.mixins.dev/">Monitoring
Mixins project</a> is an effort to centralize them.</li>
<li>Keyword search on Github:<ul>
<li><a href="https://github.com/search?q=jsonnet-libs"><code>jsonnet-libs</code></a>
Organisations often share their libraries in such a repository.</li>
<li><a href="https://github.com/search?q=libsonnet"><code>libsonnet</code></a>
Libraries are often suffixed with <code>-libsonnet</code></li>
</ul>
</li>
<li>Some applications offer jsonnet libraries to deploy, configure and/or monitor their
application, look for a <code>jsonnetfile.json</code> in their repository.</li>
<li>A few community members maintain an 'awesome list':<ul>
<li><a href="https://github.com/MacroPower/awesome-jsonnet">https://github.com/MacroPower/awesome-jsonnet</a></li>
<li><a href="https://github.com/metalmatze/awesome-jsonnet">https://github.com/metalmatze/awesome-jsonnet</a></li>
<li><a href="https://github.com/sh0rez/awesome-libsonnet">https://github.com/sh0rez/awesome-libsonnet</a></li>
</ul>
</li>
</ul>
<hr>
<h3><a id="jsonnet-bundler" href="#jsonnet-bundler">jsonnet-bundler</a></h3>
<p>Now that we can find libraries, we need a way to &quot;install&quot; them. Jsonnet libraries are
distributed as source code,  makes it quite simple process.</p>
<p>The <a href="https://github.com/jsonnet-bundler/jsonnet-bundler/">jsonnet-bundler</a> project is
the de facto package manager for Jsonnet. It vendors libraries from Git repositories and
tracks them in <code>jsonnetfile.json</code>and its corresponding lockfile <code>jsonnetfile.lock.json</code>.</p>
<p>To get started, initialize the directory with the <code>jb init</code>:</p>
<pre><code class="language-json">{
  &quot;version&quot;: 1,
  &quot;dependencies&quot;: [],
  &quot;legacyImports&quot;: true
}

// example1/jsonnetfile.json
</code></pre>
<p><code>jb init</code> creates a virtually empty <code>jsonnetfile.json</code>.</p>
<p>Originally <code>jb</code> vendored libraries as <code>vendor/&lt;name&gt;</code>, in large code bases this can cause
naming conflicts. To resolve this, <code>jb</code> started vendoring on the full repository path
<code>github.com/&lt;org&gt;/&lt;repo&gt;/&lt;path/to/lib&gt;/name</code>. However many libraries have references to
the short path, for that <code>&quot;legacyImports&quot;: true</code> tells <code>jb</code> to also create a symlink to
this full path on short path <code>vendor/&lt;name&gt;</code> to keep this working.</p>
<p>Let's vendor a library:</p>
<p><code>$ jb install github.com/jsonnet-libs/xtd</code></p>
<blockquote>
<p>For this example we use <a href="https://github.com/jsonnet-libs/xtd"><code>xtd</code></a>, it is a simple
helper library with a collection of useful functions.</p>
</blockquote>
<pre><code class="language-json">{
  &quot;version&quot;: 1,
  &quot;dependencies&quot;: [
    {
      &quot;source&quot;: {
        &quot;git&quot;: {
          &quot;remote&quot;: &quot;https://github.com/jsonnet-libs/xtd.git&quot;,
          &quot;subdir&quot;: &quot;&quot;
        }
      },
      &quot;version&quot;: &quot;master&quot;
    }
  ],
  &quot;legacyImports&quot;: true
}

// example2/jsonnetfile.json
</code></pre>
<p><code>jsonnetfile.json</code> has a new entry in the <code>dependency</code> key, it refers to the source on
Github and defaults to the <code>master</code> branch for tracking its <code>version</code>.</p>
<p>When updating libraries, it will follow the <code>version</code> tag, for example <code>jb update github.com/jsonnet-libs/xtd</code> will pull in the git commit that <code>master</code> refers to.</p>
<hr>
<pre><code class="language-json">{
  &quot;version&quot;: 1,
  &quot;dependencies&quot;: [
    {
      &quot;source&quot;: {
        &quot;git&quot;: {
          &quot;remote&quot;: &quot;https://github.com/jsonnet-libs/xtd.git&quot;,
          &quot;subdir&quot;: &quot;&quot;
        }
      },
      &quot;version&quot;: &quot;803739029925cf31b0e3c6db2f4aae09b0378a6e&quot;,
      &quot;sum&quot;: &quot;d/c+3om56mfddeYWrsxOwsrlH008BmX/5NoquXMj0+g=&quot;
    }
  ],
  &quot;legacyImports&quot;: false
}

// example2/jsonnetfile.lock.json
</code></pre>
<p>A new file <code>jsonnetfile.lock.json</code> is created, this contains the actual <code>version</code> that
should be installed, as this is a Git source it refers to a Git hash. Additionally it also
tracks a checksum value in <code>sum</code>.</p>
<p>With the lock file in place, calling <code>jb install</code> without param</p>
<hr>
<pre><code>.
├── jsonnetfile.json
├── jsonnetfile.lock.json
└── vendor
    ├── github.com
    │   └── jsonnet-libs
    │       └── xtd
    │           ├── ascii.libsonnet
    │           ├── camelcase.libsonnet
    │           ├── docs/
    │           ├── inspect.libsonnet
    │           ├── LICENSE
    │           ├── main.libsonnet
    │           ├── Makefile
    │           ├── README.md
    │           ├── test.jsonnet
    │           └── url.libsonnet
    └── xtd -&gt; github.com/jsonnet-libs/xtd
</code></pre>
<p>The library is vendored into <code>vendor/github.com/jsonnet-libs/xtd</code> and a symlink on
<code>vendor/xtd</code> was added. The <code>vendor/</code> directory is a widespread convention, tools like
Tanka look here for imports.</p>
<pre><code class="language-json">jsonnetfile.lock.json
vendor/

// example3/.gitignore
</code></pre>
<p>When shipping a library, generally only <code>jsonnetfile.json</code> is included. This way when
calling <code>jb install</code> on a library, it will pull whatever value is set in <code>version</code>. If
that is <code>master</code>, it will match the latest git commit.</p>
<p>It is often not necessary and even undesirable to distribute <code>jsonnetfile.lock.json</code> and
<code>vendor/</code> with a library, the <code>version</code> tag in <code>jsonnetfile.json</code> can be leveraged in case
a specific version is expected (for example when newer versions of dependencies have
breaking changes).</p>
<p>Add <code>jsonnetfile.lock.json</code> and <code>vendor/</code> to the <code>.gitignore</code> file so they are not
accidentally committed</p>
<hr>
<p><em>But what if <code>master</code> has a breaking change? Shouldn't the lock file be there to ensure
a specific version is installed?</em></p>
<p>Although it is uncommon that things break often (based on empirical data), it is possible
to pin to a specific version of a dependency.</p>
<p><code>$ jb install github.com/jsonnet-libs/xtd@803739029925cf31b0e3c6db2f4aae09b0378a6e</code></p>
<pre><code class="language-json">{
  &quot;version&quot;: 1,
  &quot;dependencies&quot;: [
    {
      &quot;source&quot;: {
        &quot;git&quot;: {
          &quot;remote&quot;: &quot;https://github.com/jsonnet-libs/xtd.git&quot;,
          &quot;subdir&quot;: &quot;&quot;
        }
      },
      &quot;version&quot;: &quot;803739029925cf31b0e3c6db2f4aae09b0378a6e&quot;
    }
  ],
  &quot;legacyImports&quot;: true
}

// example3/jsonnetfile.json
</code></pre>
<p>This will set <code>version</code> in <code>jsonnetfile.json</code> to ensure downstream users install the
dependency that works with the library.</p>
<p><code>jb</code> defaults to the <code>master</code> tag, new Github repos default to the <code>main</code> tag. To override
this, add <code>@main</code>:</p>
<p><code>$ jb install github.com/jsonnet-libs/xtd@main</code></p>
<p>Alternatively it is possible to pin to a certain tag:</p>
<p><code>$ jb install github.com/jsonnet-libs/xtd@v1.0</code></p>
<p><em>(eg, v1.0 tag does not exist on the xtd repo)</em></p>
<hr>
<p>There are also libraries that might have a bit of an alternative naming pattern that
doesn't align well with the <code>legacyImports</code> feature. For example
<a href="https://github.com/jsonnet-libs/istio-libsonnet"><code>istio-libsonnet</code></a> provides multiple
libraries for multiple versions of the Istio CRDs.</p>
<p>Let's install a certain version:</p>
<p><code>jb install github.com/jsonnet-libs/istio-libsonnet/1.12@main</code></p>
<pre><code>.
├── jsonnetfile.json
├── jsonnetfile.lock.json
└── vendor
    ├── 1.12 -&gt; github.com/jsonnet-libs/istio-libsonnet/1.12
    └── github.com
        └── jsonnet-libs
            └── istio-libsonnet
                └── 1.12
                    ├── _gen
                    ├── gen.libsonnet
                    └── main.libsonnet
</code></pre>
<p>This creates a symlink on <code>vendor/1.12</code>, which doesn't express clearly to which
library it refers to and can cause naming conflicts with other libraries following the
same pattern.</p>
<hr>
<p>To overcome this, we can set the name on install:</p>
<p><code>jb install github.com/jsonnet-libs/istio-libsonnet/1.12@main --legacy-name istio-lib</code></p>
<pre><code>.
├── jsonnetfile.json
├── jsonnetfile.lock.json
└── vendor
    ├── github.com
    │   └── jsonnet-libs
    │       └── istio-libsonnet
    │           └── 1.12
    │               ├── _gen
    │               ├── gen.libsonnet
    │               └── main.libsonnet
    └── istio-lib -&gt; github.com/jsonnet-libs/istio-libsonnet/1.12
</code></pre>
<p>This creates a symlink at <code>vendor/istio-lib</code>, which is easily distinguishable.</p>
<hr>
<pre><code class="language-json">{
  &quot;version&quot;: 1,
  &quot;dependencies&quot;: [
    {
      &quot;source&quot;: {
        &quot;git&quot;: {
          &quot;remote&quot;: &quot;https://github.com/jsonnet-libs/istio-libsonnet.git&quot;,
          &quot;subdir&quot;: &quot;1.13&quot;
        }
      },
      &quot;version&quot;: &quot;main&quot;,
      &quot;name&quot;: &quot;istio-lib&quot;
    }
  ],
  &quot;legacyImports&quot;: true
}

// example4/jsonnetfile.json
</code></pre>
<p>Note the <code>name</code> attribute on the <code>dependencies</code> entry, it has the value of <code>--legacy-name</code>
parameter.</p>
<p>Additionally this has the added benefit of doing in-place updates of the istio-lib. This
isn't a standard feature of jsonnet-bundler so we have to manually update
<code>jsonnetfile.json</code> and update the <code>subdir</code> attribute to <code>1.13</code>.</p>
<hr>
<pre><code>.
├── jsonnetfile.json
├── jsonnetfile.lock.json
└── vendor
    ├── github.com
    │   └── jsonnet-libs
    │       └── istio-libsonnet
    │           └── 1.13
    │               ├── _gen
    │               ├── gen.libsonnet
    │               └── main.libsonnet
    └── istio-lib -&gt; github.com/jsonnet-libs/istio-libsonnet/1.13
</code></pre>
<p>Now by calling <code>jb install</code> without additional parameters, jsonnet-bundler will replace
this library.</p>
<blockquote>
<p>This is an example on how jsonnet-bundler claims ownership over the <code>vendor/</code> directory.
It will install all libraries to match <code>jsonnetfile.json</code> complemented by
<code>jsonnetfile.lock.json</code> and it will remove everything else.</p>
</blockquote>
<hr>
<h3><a id="usage" href="#usage">Usage</a></h3>
<p>Now that we can vendor libraries, it is time to <code>import</code> and use them.</p>
<p>Let's use the <code>xtd</code> library that we installed:</p>
<pre><code class="language-jsonnet">local xtd = import 'github.com/jsonnet-libs/xtd/main.libsonnet';

xtd.ascii.isNumber('2')

// example5/usage1.jsonnet
</code></pre>
<p>Using the long path is the recommended way on how to import vendored dependencies. It
allows the authors to assume that the <code>vendor/</code> directory is in the <code>JSONNET_PATH</code> so that
dependencies don't have to be vendored relative to the library.</p>
<p>The long path provides a sufficiently unique path to prevent naming conflicts in most
cases, taking into consideration the usage of <code>legacyImports</code> and the alternative naming
pattern explained above.</p>
<hr>
<pre><code class="language-jsonnet">local xtd = import 'xtd/main.libsonnet';

xtd.ascii.isNumber('2')

// example5/usage2.jsonnet
</code></pre>
<p>If <code>legacyImports</code> was set on install, then the symlink allows to import the library with
a short handle like this. Many libraries still follow this practice.</p>
<hr>
<pre><code class="language-jsonnet">local istiolib = import 'istio-lib/main.libsonnet';

istiolib.networking.v1beta1.virtualService.new('test')

// example5/usage3.jsonnet
</code></pre>
<p>When using <code>--legacy-name istio-lib</code>, the import can look like this.</p>
<h2>Conclusion</h2>
<p>TODO</p>
<style>
html {
  margin: 0;
  padding: 0;
  min-height: 100%;
  background: lightgrey;
}
body {
  margin: 0;
  padding: 1em;
  min-height: 100%;
  margin-left: 15%;
  margin-right: 15%;
  background: white;
  border: thin solid grey;
  border-top: 0;
  /* sans-serif fonts are generally better readable for people with dyslexia */
  font-family: sans-serif;
}
blockquote {
  background: lightyellow;
  padding: .1em;
  padding-left: 1em;
  margin-left: 0;
  margin-right: 0;
  display: flow-root;
}
p {
  display: flow-root;
  line-height: 1.5em;
}
h1 a, h2 a, h3 a,
h4 a, h5 a, h6 a {
    text-decoration: none;
    color: black;
}
h1, h2, h3, h4, h5, h6, hr {
  clear: both;
}
hr {
  visibility: hidden;
}
ul {
  display: flow-root;
}
ol li,
ul li {
  line-height: 1.5em;
}
ul li code, p code {
  background: ghostwhite;
  padding: 0.2em;
}
pre {
  float: left;
  margin-top: 0;
  margin-right: 1em;
  width: 70ch;
  overflow-x: scroll;
}

li.L0, li.L1, li.L2, li.L3,
li.L5, li.L6, li.L7, li.L8 {
  list-style-type: decimal !important;
  line-height: normal;
}
</style>
<script>
var pres = document.getElementsByTagName('pre');
for (i=0;i<pres.length; i++) {
  pres[i].className='prettyprint linenums';
}
PR.prettyPrint();
</script>
<script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
</body>
</html>
