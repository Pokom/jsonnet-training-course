<!DOCTYPE html>
<html>
<head>
<title>Package management</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="md2html">
</head>
<body>
<p>[<a href="index.html">index</a>]</p>
<h1>Package management</h1>
<p>There are a ton of Jsonnet libraries out there, ranging from big generated libraries
to manually curated for a very specific purpose. Let's have a look at how to find and
vendor them.</p>
<h2>Objectives</h2>
<ul>
<li>Find existing libraries</li>
<li>Vendor and update libraries with jsonnet-bundler</li>
<li><code>import</code> and use a vendored library with <code>JSONNET_PATH</code></li>
<li>Develop on a vendored library</li>
<li>Generate new libraries from specifications</li>
</ul>
<h2>Lesson</h2>
<p>The ecosystem for Jsonnet libraries has organically grown and is quite distributed, there
is no central entity in control. Even though this gives the authors a great deal of
autonomy, it makes it harder to find libraries. The majority of libraries can be found in
Git repositories and are wholeheartedly open source.</p>
<ul>
<li>Github Topic <a href="https://github.com/topics/jsonnet-lib"><code>jsonnet-lib</code></a> lists the libraries
that are tagged with <code>jsonnet-lib</code>. Cultivating this tag is encouraged.</li>
<li>In the observability space, there is a sub-ecosystem of &quot;mixins&quot;. The <a href="https://monitoring.mixins.dev/">Monitoring
Mixins project</a> is an effort to centralize them.</li>
<li>Keyword search on Github:<ul>
<li><a href="https://github.com/search?q=jsonnet-libs"><code>jsonnet-libs</code></a>
Organisations often share their libraries in such a repository.</li>
<li><a href="https://github.com/search?q=libsonnet"><code>libsonnet</code></a>
Libraries are often suffixed with <code>-libsonnet</code></li>
</ul>
</li>
<li>Some applications offer jsonnet libraries to deploy, configure and/or monitor their
application, look for a <code>jsonnetfile.json</code> in their repository.</li>
<li>A few community members maintain an 'awesome list':<ul>
<li><a href="https://github.com/MacroPower/awesome-jsonnet">https://github.com/MacroPower/awesome-jsonnet</a></li>
<li><a href="https://github.com/metalmatze/awesome-jsonnet">https://github.com/metalmatze/awesome-jsonnet</a></li>
<li><a href="https://github.com/sh0rez/awesome-libsonnet">https://github.com/sh0rez/awesome-libsonnet</a></li>
</ul>
</li>
</ul>
<hr>
<h3>jsonnet-bundler</h3>
<p>Now that we can find libraries, we need a way to &quot;install&quot; them. Jsonnet libraries are
distributed as source code,  makes it quite simple process.</p>
<p>The <a href="https://github.com/jsonnet-bundler/jsonnet-bundler/">jsonnet-bundler</a> project is
the de facto package manager for Jsonnet. It vendors libraries from Git repositories and
tracks them in <code>jsonnetfile.json</code>and its corresponding lockfile <code>jsonnetfile.lock.json</code>.</p>
<p>To get started, initialize the directory:</p>
<p><code>$ jb init</code></p>
<pre><code class="language-json">{
  &quot;version&quot;: 1,
  &quot;dependencies&quot;: [],
  &quot;legacyImports&quot;: true
}

// example1/jsonnetfile.json
</code></pre>
<p><code>jb init</code> creates a virtually empty <code>jsonnetfile.json</code>.</p>
<hr>
<p>Let's vendor the <a href="https://github.com/jsonnet-libs/xtd"><code>xtd</code></a> library:</p>
<p><code>$ jb install github.com/jsonnet-libs/xtd</code></p>
<blockquote>
<p>The default tag used by jsonnet-bundler is <code>master</code>, new Github repos default to the
<code>main</code> tag. To override this, add <code>@main</code>:</p>
<p><code>$ jb install github.com/jsonnet-libs/xtd@main</code></p>
</blockquote>
<pre><code class="language-json">{
  &quot;version&quot;: 1,
  &quot;dependencies&quot;: [
    {
      &quot;source&quot;: {
        &quot;git&quot;: {
          &quot;remote&quot;: &quot;https://github.com/jsonnet-libs/xtd.git&quot;,
          &quot;subdir&quot;: &quot;&quot;
        }
      },
      &quot;version&quot;: &quot;master&quot;
    }
  ],
  &quot;legacyImports&quot;: true
}

// example2/jsonnetfile.json
</code></pre>
<p><code>jsonnetfile.json</code> has a new entry in the <code>dependency</code> key, it refers to the source on
Github and defaults to the <code>master</code> branch for tracking its <code>version</code>.</p>
<p>When updating libraries, it will follow the <code>version</code> tag, for example <code>jb update github.com/jsonnet-libs/xtd</code> will pull in the git commit that <code>master</code> refers to.</p>
<hr>
<pre><code class="language-json">{
  &quot;version&quot;: 1,
  &quot;dependencies&quot;: [
    {
      &quot;source&quot;: {
        &quot;git&quot;: {
          &quot;remote&quot;: &quot;https://github.com/jsonnet-libs/xtd.git&quot;,
          &quot;subdir&quot;: &quot;&quot;
        }
      },
      &quot;version&quot;: &quot;803739029925cf31b0e3c6db2f4aae09b0378a6e&quot;,
      &quot;sum&quot;: &quot;d/c+3om56mfddeYWrsxOwsrlH008BmX/5NoquXMj0+g=&quot;
    }
  ],
  &quot;legacyImports&quot;: false
}

// example2/jsonnetfile.lock.json
</code></pre>
<p>A new file <code>jsonnetfile.lock.json</code> is created, this contains the actual <code>version</code> that
should be installed, as this is a Git source it refers to a Git hash. Additionally it also
tracks a checksum value in <code>sum</code>.</p>
<hr>
<pre><code>.
├── jsonnetfile.json
├── jsonnetfile.lock.json
└── vendor
    ├── github.com
    │   └── jsonnet-libs
    │       └── xtd
    │           ├── ascii.libsonnet
    │           ├── camelcase.libsonnet
    │           ├── docs/
    │           ├── inspect.libsonnet
    │           ├── LICENSE
    │           ├── main.libsonnet
    │           ├── Makefile
    │           ├── README.md
    │           ├── test.jsonnet
    │           └── url.libsonnet
    └── xtd -&gt; github.com/jsonnet-libs/xtd
</code></pre>
<p>The library is vendored into <code>vendor/github.com/jsonnet-libs/xtd</code> and a symlink on
<code>vendor/xtd</code> was added. The <code>vendor/</code> directory is a widespread convention.</p>
<hr>
<p>When shipping a library, generally only <code>jsonnetfile.json</code> is included. This way when
calling <code>jb install</code> on a library, it will pull whatever value is set in <code>version</code>. If
that is <code>master</code>, it will match the latest git commit.</p>
<p>It is often not necessary and even undesirable to distribute <code>jsonnetfile.lock.json</code> and
<code>vendor/</code> with a library, the <code>version</code> tag in <code>jsonnetfile.json</code> can be leveraged in case
a specific version is expected (for example when newer versions of dependencies have
breaking changes).</p>
<pre><code class="language-json">jsonnetfile.lock.json
vendor/

// example3/.gitignore
</code></pre>
<p>Add <code>jsonnetfile.lock.json</code> and <code>vendor/</code> to the <code>.gitignore</code> file so they are not
accidentally committed</p>
<h3>Usage</h3>
<p>Now that we can vendor libraries, it is time to <code>import</code> and use them.</p>
<pre><code class="language-jsonnet">local xtd = import 'github.com/jsonnet-libs/xtd/main.libsonnet';

xtd.ascii.isNumber('2')

// example5/usage1.jsonnet
</code></pre>
<p>Using the long path is the recommended way on how to import vendored dependencies. It
builds on the assumption that the <code>vendor/</code> directory is in the
<a href="#jsonnet_path"><code>JSONNET_PATH</code></a> so that dependencies don't have to be vendored relative to
the library.</p>
<p>The long path provides a sufficiently unique path to prevent naming conflicts in most
cases, taking into consideration the usage of <code>legacyImports</code> and the alternative naming
pattern explained above.</p>
<hr>
<pre><code class="language-jsonnet">local xtd = import 'xtd/main.libsonnet';

xtd.ascii.isNumber('2')

// example5/usage2.jsonnet
</code></pre>
<p>If <code>legacyImports</code> was set on install, then the symlink allows to import the library with
a short handle like this. Many libraries still follow this practice.</p>
<hr>
<blockquote>
<p><strong>Legacy Imports</strong></p>
<p>Originally <code>jb</code> vendored libraries as <code>vendor/&lt;name&gt;</code>, in large code bases this can
cause naming conflicts. To resolve this, <code>jb</code> started vendoring on the full repository
path <code>github.com/&lt;org&gt;/&lt;repo&gt;/&lt;path/to/lib&gt;/name</code>. However many libraries have
references to the short path, for that <code>&quot;legacyImports&quot;: true</code> tells <code>jb</code> to also create
a symlink to this full path on short path <code>vendor/&lt;name&gt;</code> to keep this working.</p>
</blockquote>
<h3><code>JSONNET_PATH</code></h3>
<p><code>JSONNET_PATH</code> is a semicolon <code>:</code> separated list of directories that <code>jsonnet</code> will
attempt to resolve imports from. Two common paths are <code>vendor/</code> and <code>lib/</code>, relative to
the project root, which is usually indicated by a <code>jsonnetfile.json</code>.</p>
<p><code>$ JSONNET_PATH=&quot;lib/:vendor/&quot; jsonnet usage2.jsonnet</code></p>
<p><em>Order matters: <code>JSONNET_PATH</code> follows FIFO, if the import is found in <code>lib/</code> then it will
not look in <code>vendor/</code>.</em></p>
<p>This will resolve the imports until it finds a match:</p>
<ul>
<li>✗ <code>./xtd/main.libsonnet</code></li>
<li>✗ <code>./lib/xtd/main.libsonnet</code></li>
<li>✓ <code>./vendor/xtd/main.libsonnet</code></li>
</ul>
<p>Alternatively it is possible to add paths as attributes to <code>jsonnet</code>:</p>
<p><code>$ jsonnet -J vendor/ -J lib/ usage2.jsonnet</code></p>
<p><em>Order matters: <code>-J</code> follows LIFO, if the import is found in <code>lib/</code> then it will not look
in <code>vendor/</code>.</em></p>
<h3>Advanced</h3>
<p>As package management is quite distributed and jsonnet-bundler is relatively simple, there
are some use cases that don't get covered well. Fortunately jsonnet and jsonnet-bundler
are quite flexible.</p>
<h4>Upstream has breaking changes</h4>
<p>It may happen that the upstream tracking branch (eg. <code>master</code>) introduce breaking changes.
A first response may be to ship the <code>jsonnetfile.lock.json</code> alongside the library, however
this also pins the version of all other libraries, which is often undesirable. It would be
better to pin the version in <code>jsonnetfile.json</code>.</p>
<pre><code class="language-json">{
  &quot;version&quot;: 1,
  &quot;dependencies&quot;: [
    {
      &quot;source&quot;: {
        &quot;git&quot;: {
          &quot;remote&quot;: &quot;https://github.com/jsonnet-libs/xtd.git&quot;,
          &quot;subdir&quot;: &quot;&quot;
        }
      },
      &quot;version&quot;: &quot;803739029925cf31b0e3c6db2f4aae09b0378a6e&quot;
    }
  ],
  &quot;legacyImports&quot;: true
}

// example3/jsonnetfile.json
</code></pre>
<p>This can be done by setting <code>version</code> on a dependency, you can use <code>jb install</code> for this.</p>
<p>If authors are aware, then they often provide a version tag (eg. <code>v1.0</code>):</p>
<p><code>$ jb install github.com/jsonnet-libs/xtd@v1.0</code></p>
<p><em>(eg. v1.0 tag does not exist on the xtd repo)</em></p>
<p>It is also possible to pin to a very specific commit:</p>
<p><code>$ jb install github.com/jsonnet-libs/xtd@803739029925cf31b0e3c6db2f4aae09b0378a6e</code></p>
<h4>Alternative naming pattern</h4>
<p>There are also libraries that might have a bit of an alternative naming pattern that
doesn't align well with the <code>legacyImports</code> feature. For example
<a href="https://github.com/jsonnet-libs/istio-libsonnet"><code>istio-libsonnet</code></a> provides multiple
libraries for multiple versions of the Istio CRDs.</p>
<p>Let's install a certain version:</p>
<p><code>jb install github.com/jsonnet-libs/istio-libsonnet/1.12@main</code></p>
<pre><code>.
├── jsonnetfile.json
├── jsonnetfile.lock.json
└── vendor
    ├── 1.12 -&gt; github.com/jsonnet-libs/istio-libsonnet/1.12
    └── github.com
        └── jsonnet-libs
            └── istio-libsonnet
                └── 1.12
                    ├── _gen
                    ├── gen.libsonnet
                    └── main.libsonnet
</code></pre>
<p>This creates a symlink on <code>vendor/1.12</code>, which doesn't express clearly to which
library it refers to and can cause naming conflicts with other libraries following the
same pattern.</p>
<hr>
<p>To overcome this, we can set the name on install:</p>
<p><code>jb install github.com/jsonnet-libs/istio-libsonnet/1.12@main --legacy-name istio-lib</code></p>
<pre><code>.
├── jsonnetfile.json
├── jsonnetfile.lock.json
└── vendor
    ├── github.com
    │   └── jsonnet-libs
    │       └── istio-libsonnet
    │           └── 1.12
    │               ├── _gen
    │               ├── gen.libsonnet
    │               └── main.libsonnet
    └── istio-lib -&gt; github.com/jsonnet-libs/istio-libsonnet/1.12
</code></pre>
<p>This creates a symlink at <code>vendor/istio-lib</code>, which is easily distinguishable.</p>
<hr>
<pre><code class="language-json">{
  &quot;version&quot;: 1,
  &quot;dependencies&quot;: [
    {
      &quot;source&quot;: {
        &quot;git&quot;: {
          &quot;remote&quot;: &quot;https://github.com/jsonnet-libs/istio-libsonnet.git&quot;,
          &quot;subdir&quot;: &quot;1.13&quot;
        }
      },
      &quot;version&quot;: &quot;main&quot;,
      &quot;name&quot;: &quot;istio-lib&quot;
    }
  ],
  &quot;legacyImports&quot;: true
}

// example4/jsonnetfile.json
</code></pre>
<p>Note the <code>name</code> attribute on the <code>dependencies</code> entry, it has the value of <code>--legacy-name</code>
parameter.</p>
<p>Additionally this has the added benefit of doing in-place updates of the istio-lib. This
isn't a standard feature of jsonnet-bundler so we have to manually update
<code>jsonnetfile.json</code> and update the <code>subdir</code> attribute to <code>1.13</code>.</p>
<hr>
<pre><code>.
├── jsonnetfile.json
├── jsonnetfile.lock.json
└── vendor
    ├── github.com
    │   └── jsonnet-libs
    │       └── istio-libsonnet
    │           └── 1.13
    │               ├── _gen
    │               ├── gen.libsonnet
    │               └── main.libsonnet
    └── istio-lib -&gt; github.com/jsonnet-libs/istio-libsonnet/1.13
</code></pre>
<p>Now by calling <code>jb install</code> without additional parameters, jsonnet-bundler will replace
this library.</p>
<blockquote>
<p>This is an example on how jsonnet-bundler claims ownership over the <code>vendor/</code> directory.
It will install all libraries to match <code>jsonnetfile.json</code> complemented by
<code>jsonnetfile.lock.json</code> and it will remove everything else.</p>
</blockquote>
<hr>
<pre><code class="language-jsonnet">local istiolib = import 'istio-lib/main.libsonnet';

istiolib.networking.v1beta1.virtualService.new('test')

// example5/usage3.jsonnet
</code></pre>
<p>When using <code>--legacy-name istio-lib</code>, the import can look like this.</p>
<h4>Shortcut in <code>lib/</code></h4>
<p>Another pattern to naming a dependency with jsonnet-bundler is to create a local library
with the purpose of providing a shortcut.</p>
<pre><code class="language-jsonnet">(import 'github.com/jsonnet-libs/istio-libsonnet/1.13/main.libsonnet')

// example5/lib/istiolib.libsonnet
</code></pre>
<pre><code class="language-jsonnet">local istiolib = import 'istiolib.libsonnet';

istiolib.networking.v1beta1.virtualService.new('test')

// example5/usage4.jsonnet
</code></pre>
<p>The added advantage of this approach is the ability add local overrides for the library in
<code>lib/istiolib.libsonnet</code>. It is also doesn't depend on the <code>jsonnet-bundler</code> behavior.</p>
<p>Note the location of this library, <code>lib/</code> is another directory is commonly added to
<a href="#jsonnet_path"><code>JSONNET_PATH</code></a> as to where libraries can <code>import</code> dependencies from.</p>
<h3>Development</h3>
<p>It often happens that a vendored library is developed alongside the environment that is
using it. However <code>jb install</code> will reset the contents of edits in <code>vendor/</code>, so that is
not an ideal location to develop a library.</p>
<p>TODO: several options here, not sure which is most useful</p>
<ul>
<li>Simply edit in <code>vendor/</code>, copy over the contents to the local path, risk of <code>jb install</code>
removing the changes.</li>
<li>Git clone/checkout/submodule in <code>vendor/</code>, same risk of <code>jb install</code> removing the
changes.</li>
<li>Change jsonnetfile.json to use file://path/to/local/library</li>
<li>Depend on import order and symlink/develop in <code>lib/</code>, taking precedence over <code>vendor/</code>.</li>
</ul>
<blockquote>
<p>Idea: perhaps jsonnet-bundler could benefit from an --editable feature like <code>pip</code>.</p>
</blockquote>
<h2>Conclusion</h2>
<p>TODO</p>
<style>
html {
    margin: 0;
    padding: 0;
    min-height: 100%;
    background: lightgrey;
}

body {
    margin: 0;
    padding: 1.2em;
    min-height: 100%;
    margin-left: 15%;
    margin-right: 15%;
    background: white;
    border: thin solid grey;
    border-top: 0;
    /* sans-serif fonts are generally better readable for people with dyslexia */
    font-family: sans-serif;
    font-size: 1.15rem;
}

blockquote {
    background: lightyellow;
    padding: .1em;
    padding-left: 1em;
    margin-left: 0;
    margin-right: 0;
    display: flow-root;
    font-size: 1rem;
}

p {
    display: flow-root;
    line-height: 1.5em;
}

h1 a, h2 a, h3 a,
h4 a, h5 a, h6 a {
    text-decoration: none;
    color: black;
}

a.anchor-link {
    font-size: 0.9rem;
    vertical-align: middle;
    line-height: 1;
    margin: 0.2em;
    margin-left: -1.2em;
}

h1, h2, h3, h4, h5, h6, hr {
    clear: both;
}

hr {
    visibility: hidden;
}

ol, ul {
    display: flow-root;
}

ol li,
ul li {
    line-height: 1.5em;
}

ul li code, p code {
    background: ghostwhite;
    padding: 0.2em;
}

pre ol {
    display: block;
}

pre {
    float: left;
    margin-top: 0;
    margin-right: 1em;
    width: min(50%, 70ch);
    overflow-x: scroll;
}

@media only screen and (max-width: 720px) {
    body {
        width: auto;
        margin-left: 0;
        margin-right: 0;
        border: 0;
    }
    pre {
        clear: both;
        float: none;
        width: min(95%, 70ch);
    }
}

li.L0, li.L1, li.L2, li.L3,
li.L5, li.L6, li.L7, li.L8 {
    list-style-type: decimal !important;
    line-height: normal;
}

</style>
<script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
<script>
var pres = document.getElementsByTagName('pre');
for (i=0;i<pres.length; i++) {
    pres[i].className='prettyprint linenums';
}
PR.prettyPrint();

// Source: https://attacomsian.com/blog/deep-anchor-links-javascript
document.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach($heading => {
    //create id from heading text
    var id = $heading.getAttribute("id") || $heading.innerText.toLowerCase().replace(/[`~!@#$%^&*()|+\-=?;:'",.<>\{\}\[\]\\\/]/gi, '').replace(/ +/g, '-');

    //add id to heading
    $heading.setAttribute('id', id);

    //append parent class to heading
    $heading.classList.add('anchor-heading');

    //create anchor
    $anchor = document.createElement('a');
    $anchor.className = 'anchor-link';
    $anchor.href = '#' + id;
    $anchor.innerHTML = '☍';
    var text = $heading.innerText;

    //append anchor after heading text
    $heading.innerText = "";
    $heading.appendChild($anchor);
    $heading.append(text);
});

</script>
</body>
</html>
