<!DOCTYPE html>
<html>
<head>
<title>Exercise: rewrite a library with <code>k8s-libsonnet</code></title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="md2html">
</head>
<body>
<p>[<a href="index.html">index</a>]</p>
<h1>Exercise: rewrite a library with <code>k8s-libsonnet</code></h1>
<p>In the first lesson we've written a extensible library and in the second lesson we've
covered package management with jsonnet-bundler. In this lesson we'll combine what
we've learned and rewrite that library.</p>
<h2>Objectives</h2>
<ul>
<li>Rewrite a library</li>
<li>Vendor and use <code>k8s-libsonnet</code></li>
<li>Understand the <code>lib/k.libsonnet</code> convention</li>
</ul>
<h2>Lesson</h2>
<p>In <a href="lesson1.html">Write an extensible library</a>, we created this library:</p>
<pre><code class="language-jsonnet">local webserver = {
  new(name, replicas=1): {
    local base = self,

    container:: {
      name: 'httpd',
      image: 'httpd:2.4',
    },

    deployment: {
      apiVersion: 'apps/v1',
      kind: 'Deployment',
      metadata: {
        name: name,
      },
      spec: {
        replicas: replicas,
        template: {
          spec: {
            containers: [
              base.container,
            ],
          },
        },
      },
    },
  },

  withImage(image): {
    container+: { image: image },
  },
};

webserver.new('wonderful-webserver')
+ webserver.withImage('httpd:2.5')

// example1.jsonnet
</code></pre>
<p>This library is quite verbose as the author has to provide the <code>apiVersion</code>, <code>kind</code> and
other attributes.</p>
<p>To simplify this, the community has created a Kubernetes client library for Jsonnet called
<a href="https://github.com/jsonnet-libs/k8s-libsonnet"><code>k8s-libsonnet</code></a>. By leveraging this
client library, the author can provide an abstraction that can work across most Kubernetes
versions.</p>
<hr>
<p>Let's install <code>k8s-libsonnet</code> with jsonnet-bundler and import it:</p>
<p><code>$ jb install https://github.com/jsonnet-libs/k8s-libsonnet/1.23@main</code></p>
<p>Note the alternative naming pattern ending on <code>1.23</code>, referencing the Kubernetes version
this was generated for.</p>
<pre><code class="language-jsonnet">(import 'github.com/jsonnet-libs/k8s-libsonnet/1.23/main.libsonnet')

// example2/lib/k.libsonnet
</code></pre>
<p>The most common convention to work with this is to provide <code>lib/k.libsonnet</code> as
a shortcut.</p>
<pre><code class="language-jsonnet">local k = import 'k.libsonnnet';

// example2/example1.jsonnet
</code></pre>
<p>Many libraries have a line <code>local k = import 'k.libsonnet'</code> to refer to this
library.</p>
<h2>Conclusion</h2>
<p>TODO</p>
<style>
html {
    margin: 0;
    padding: 0;
    min-height: 100%;
    background: lightgrey;
}

body {
    margin: 0;
    padding: 1em;
    min-height: 100%;
    margin-left: 15%;
    margin-right: 15%;
    background: white;
    border: thin solid grey;
    border-top: 0;
    /* sans-serif fonts are generally better readable for people with dyslexia */
    font-family: sans-serif;
    font-size: 1.15rem;
}

blockquote {
    background: lightyellow;
    padding: .1em;
    padding-left: 1em;
    margin-left: 0;
    margin-right: 0;
    display: flow-root;
}

p {
    display: flow-root;
    line-height: 1.5em;
}

h1 a, h2 a, h3 a,
h4 a, h5 a, h6 a {
    text-decoration: none;
    color: black;
}

a.anchor-link {
    font-size: 0.9rem;
    vertical-align: middle;
    margin: 0.2em;
}

h1, h2, h3, h4, h5, h6, hr {
    clear: both;
}

hr {
    visibility: hidden;
}

ul {
    display: flow-root;
}

ol li,
ul li {
    line-height: 1.5em;
}

ul li code, p code {
    background: ghostwhite;
    padding: 0.2em;
}

pre {
    float: left;
    margin-top: 0;
    margin-right: 1em;
    width: min(50%, 70ch);
    overflow-x: scroll;
}

@media only screen and (max-width: 720px) {
    body {
        width: auto;
        margin-left: 0;
        margin-right: 0;
        border: 0;
    }
    pre {
        clear: both;
        float: none;
        width: min(95%, 70ch);
    }
}

li.L0, li.L1, li.L2, li.L3,
li.L5, li.L6, li.L7, li.L8 {
    list-style-type: decimal !important;
    line-height: normal;
}

</style>
<script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
<script>
var pres = document.getElementsByTagName('pre');
for (i=0;i<pres.length; i++) {
    pres[i].className='prettyprint linenums';
}
PR.prettyPrint();

// Source: https://attacomsian.com/blog/deep-anchor-links-javascript
document.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach($heading => {
    //create id from heading text
    var id = $heading.getAttribute("id") || $heading.innerText.toLowerCase().replace(/[`~!@#$%^&*()_|+\-=?;:'",.<>\{\}\[\]\\\/]/gi, '').replace(/ +/g, '-');

    //add id to heading
    $heading.setAttribute('id', id);

    //append parent class to heading
    $heading.classList.add('anchor-heading');

    //create anchor
    $anchor = document.createElement('a');
    $anchor.className = 'anchor-link';
    $anchor.href = '#' + id;
    $anchor.innerHTML = '‚òç';

    //append anchor after heading text
    $heading.appendChild($anchor);
});

</script>
</body>
</html>
